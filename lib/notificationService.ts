import axios from 'axios';
import { BACKEND_URL } from './api';

const API_URL = `${BACKEND_URL}/api/notifications`;

export interface Notification {
  _id: string;
  recipientId: string;
  senderId: string;
  type: 'like' | 'comment' | 'follow' | 'mention';
  postId?: string;
  message: string;
  read: boolean;
  createdAt: string;
  readAt?: string;
}

export const notificationService = {
  // Get user notifications
  async getNotifications(userId: string, limit = 50, skip = 0): Promise<Notification[]> {
    try {
      const response = await axios.get(`${API_URL}/${userId}`, {
        params: { limit, skip }
      });
      console.log('[notificationService] Fetched', response.data.data?.length || 0, 'notifications');
      return response.data.data || [];
    } catch (err) {
      console.error('[notificationService] Error fetching notifications:', err);
      return [];
    }
  },

  // Create notification (for likes, comments, follows)
  async createNotification(
    recipientId: string,
    senderId: string,
    type: 'like' | 'comment' | 'follow' | 'mention',
    postId?: string,
    message?: string
  ): Promise<Notification | null> {
    try {
      const response = await axios.post(API_URL, {
        recipientId,
        senderId,
        type,
        postId,
        message
      });
      console.log('[notificationService] Created', type, 'notification');
      return response.data.data;
    } catch (err) {
      console.error('[notificationService] Error creating notification:', err);
      return null;
    }
  },

  // Mark notification as read
  async markAsRead(notificationId: string): Promise<boolean> {
    try {
      await axios.patch(`${API_URL}/${notificationId}/read`);
      console.log('[notificationService] Marked notification as read:', notificationId);
      return true;
    } catch (err) {
      console.error('[notificationService] Error marking as read:', err);
      return false;
    }
  },

  // Send like notification
  async notifyLike(postOwnerId: string, likerId: string, postId: string) {
    return this.createNotification(
      postOwnerId,
      likerId,
      'like',
      postId,
      'liked your post'
    );
  },

  // Send comment notification
  async notifyComment(postOwnerId: string, commenterId: string, postId: string) {
    return this.createNotification(
      postOwnerId,
      commenterId,
      'comment',
      postId,
      'commented on your post'
    );
  },

  // Send follow notification
  async notifyFollow(followedUserId: string, followerId: string) {
    return this.createNotification(
      followedUserId,
      followerId,
      'follow',
      undefined,
      'started following you'
    );
  }
};
